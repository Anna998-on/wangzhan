<!DOCTYPE html>
<html>

<head>
  <title>Contact</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- 在HTML头部添加版本号强制更新 -->
  <link rel="stylesheet" href="style.css?v=20231101">
  <script src="app.js?v=20231101"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="keywords" content="" />
  <!-- 在head标签内添加 -->
  <script
    type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
  <!-- Custom Theme files -->
  <link href="css/bootstrap.css" type="text/css" rel="stylesheet" media="all">
  <link href="css/style.css" type="text/css" rel="stylesheet" media="all">
  <!-- //Custom Theme files -->
  <!-- js -->
  <script src="js/jquery-1.11.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- //js -->
  <!-- web-fonts -->
  <link href='https://fonts.googleapis.com/css?family=Redressed' rel='stylesheet'>
  <link
    href='https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap'
    rel='stylesheet'>

  <style>
    /* 其他原有样式保持不变 */
    /* 新增目标进度条样式 */
    /* 统一样式定义 */
    :root {
      --primary-color: #ffffff;
      /* 马卡龙绿色 */
      --secondary-color: #75c9b7;
      /* 稍深的绿色 */
      --hover-color: #5abf9d;
      /* 悬停绿色 */
      --text-color: #333333;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }



    body {
      max-width: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    header {
      width: 100vw !important;
      /* 强制视窗宽度 */
      margin-left: calc(-50vw + 50%);
      /* 居中修正（如果 body 有 padding/margin） */
      padding: 15px 0;
      box-sizing: border-box;
      background-color: var(--primary-color);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    nav {
      margin-left: 100px;
      /* 整个导航区域向右移动40px */
      /* 其他样式保持不变 */
    }

    /* 确保header容器不会换行 */
    header {
      white-space: nowrap;
      /* 禁止内容换行 */
      overflow: visible;
      /* 确保内容不会被隐藏 */
    }

    /* 调整header-container为flex布局并禁止换行 */
    .header-container {
      display: flex;
      align-items: center;
      /* 垂直居中 */
      flex-wrap: nowrap;
      /* 禁止换行 */
      min-width: 100%;
      /* 确保容器足够宽 */
    }

    /* 调整logo和nav的布局 */
    .logo {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      /* 禁止缩小 */
      gap: 15px;
    }

    /* 确保 nav 右对齐 */
    nav {
      margin-left: 150px;
      /* 替换原来的100px，根据需要调整数值 */
    }

    /* 保持其他样式不变，只修改这一条 */
    /* 修改现有样式中的padding值 */
    nav ul li a {
      padding: 8px 4px;
      /* 原为8px 12px，现减少右侧内边距 */
      /* 其他样式保持不变 */
    }

    /* 可选：调整导航项间距 */
    nav ul {
      gap: 15px;
      display: flex;
      justify-content: flex-start;
      /* 左对齐 */
      padding-left: 0;
      /* 移除默认的 ul 左内边距 */
      margin-left: 0;
      /* 移除默认的 ul 左外边距 */
    }

    /* 确保 logo 不挤压导航 */
    .logo {
      flex-shrink: 0;
      /* 禁止 logo 缩小 */
    }

    /* 确保导航菜单不换行 */
    nav ul {
      display: flex;
      flex-wrap: nowrap;
      /* 禁止换行 */
      white-space: nowrap;
      /* 双重保险 */
    }



    /* 调整导航项间距 */
    nav ul li {
      flex-shrink: 0;
      /* 禁止导航项缩小 */
    }


    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo img {
      height: 50px;
      transition: var(--transition);
    }

    .logo img:hover {
      transform: rotate(5deg) scale(1.05);
    }

    .logo span {
      color: var(--text-color);
      font-size: 5.2rem;
      font-weight: 700;
      letter-spacing: 1px;
      font-family: "KaiTi", "楷体", "楷体_GB2312", serif;
      /* 添加这行 */
    }

    nav ul {
      /* 删除或注释掉这行 */
      /* margin-left: -300px; */

      /* 保留这些基本样式 */
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    nav ul li {
      position: relative;
    }

    nav ul li a {
      text-decoration: none;
      color: var(--text-color);
      font-weight: 600;
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 4px;
      transition: var(--transition);
      position: relative;
    }

    nav ul li a:hover {
      color: white;
      background-color: var(--hover-color);
    }

    nav ul li a.active {
      background-color: var(--secondary-color);
      color: white;
    }

    .logo {
      margin-left: 30px;
      /* 向右移动30px，数值可调 */
      /* 其他原有样式保持不变 */
    }

    nav ul li a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: 0;
      left: 50%;
      background-color: var(--secondary-color);
      transition: var(--transition);
      transform: translateX(-50%);
    }

    nav ul li a:hover::after {
      width: 80%;
    }

    .hamburger {
      display: none;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .logo span {
        font-size: 1.2rem;
        /* 移动端减小字体 */
      }

      .hamburger {
        display: block;
      }

      nav ul {
        position: fixed;
        top: 80px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 80px);
        background-color: var(--primary-color);
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 30px;
        transition: var(--transition);
      }

      nav ul.active {
        left: 0;
      }
    }

    body {
      background-image: url('images/baohu.png');
      /* 背景图的URL */
      background-size: cover;
      /* 让背景图覆盖整个元素 */
      background-position: center;
      /* 背景图居中显示 */
      background-repeat: no-repeat;
      /* 背景图不重复 */
    }

    .chart-item canvas {
      width: 100% !important;
      height: 100% !important;
    }

    :root {
      --primary-color: #ffffff;
      --primary-dark: #1b5e20;
      --error-color: #c62828;
      --warning-color: #FFC107;
    }

    /* 移动端优先的响应式设计 */
    .container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 1rem;
    }

    @media (min-width: 900px) {
      .container {
        flex-direction: row;
      }

      .top-row {
        display: flex;
        gap: 1.25rem;
      }
    }

    /* 统一按钮样式 */
    button,
    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover,
    .btn:hover {
      background-color: var(--primary-dark);
    }

    .goal-progress {
      background: #e0e0e0;
      border-radius: 12px;
      height: 24px;
      margin: 10px 0;
    }

    .goal-progress-bar {
      height: 100%;
      border-radius: 12px;
      background: #2e7d32;
      transition: width 0.3s ease;
    }

    /* 添加这些样式 */
    .top-row {
      display: flex;
      gap: 20px;
    }

    .form-section {
      flex: 1;
    }

    .list-section {
      flex: 2;
      overflow-x: auto;
      /* 添加滚动条以防表格太宽 */
    }

    /* 响应式设计 - 小屏幕时垂直排列 */
    @media (max-width: 900px) {
      .top-row {
        flex-direction: column;
      }
    }

    table {
      min-width: 600px;
      /* 确保表格有足够宽度 */
    }

    /* 数据导出按钮样式 */
    .export-btn {
      background: #1565C0;
      margin-top: 10px;
    }

    /* 建议卡片样式 */
    .tip-card {
      background: #FFF8E1;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f9f5;
    }

    .container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-section,
    .list-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-section {
      flex: 1;
    }

    .list-section {
      flex: 2;
    }

    h1,
    h2 {
      color: #25b431;
    }

    form div {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #2e7d32;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1b5e20;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #e8f5e9;
    }

    .chart-container {
      margin-top: 30px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chart-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-item {
      flex: 1;
      height: 300px;
    }

    .action-buttons button {
      padding: 5px 10px;
      margin-right: 5px;
    }

    .comparison-positive {
      color: #f44336;
      font-weight: bold;
    }

    .comparison-negative {
      color: #4CAF50;
      font-weight: bold;
    }

    .month-selector {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .month-selector select {
      width: auto;
      flex: 1;
    }

    .container {
      display: flex;
      flex-direction: column;
      /* 改为垂直排列 */
      gap: 30px;
      /* 增加行间距 */
      margin-bottom: 20px;
    }

    .top-row {
      display: flex;
      gap: 20px;
    }

    .chart-container {
      margin-top: 0;
      /* 移除原来的上边距 */
    }
  </style>
  <!-- //web-fonts -->

  <!-- start-smooth-scrolling -->
  <script type="text/javascript" src="js/move-top.js"></script>
  <script type="text/javascript" src="js/easing.js"></script>
  <script type="text/javascript">
    jQuery(document).ready(function ($) {
      $(".scroll").click(function (event) {
        event.preventDefault();

        $('html,body').animate({ scrollTop: $(this.hash).offset().top }, 1000);
      });
    });
  </script>
  <!-- //end-smooth-scrolling -->
</head>

<body>
  <!-- banner -->

  <!-- header -->
  <header>
    <div class="header-container">
      <div class="logo">
        <img src="images/logo.png" alt="Logo">
        <span>绿碳</span>
      </div>
      <nav>
        <ul>

          <!-- 在所有页面统一使用以下路径 -->
          <li><a href="index.html" class="nav-link footprint">首页</a></li>
          <li><a href="concept.html" class="nav-link concept">绿碳相关概念</a></li>
          <li><a href="policy.html" class="nav-link policy">国家政策</a></li>
          <li><a href="hhh.html" class="nav-link footprint">个人碳足迹</a></li>

        </ul>
      </nav>
    </div>
  </header>
  <!-- //header -->
  <!-- banner-text -->

  <!-- //contact -->
  <h1 class="hhh" style="color: white;"></h1>
  <div class="container">
    <div class="top-row">
      <div class="form-section">
        <h2>月度减排目标</h2>
        <div id="goalSection">
          <input type="number" id="monthlyGoal" placeholder="输入目标排放量(kg)">
          <button onclick="setMonthlyGoal()">设定目标</button>
          <div class="goal-progress">
            <div class="goal-progress-bar" id="goalProgress"></div>
          </div>
          <p id="goalStatus"></p>
        </div>
        <h2>添加碳足迹记录</h2>
        <form id="carbonForm">
          <div>
            <label for="date">日期</label>
            <input type="date" id="date" required>
          </div>
          <div>
            <label for="category">类别</label>
            <select id="category" required>
              <option value="">请选择...</option>
              <option value="transport">交通</option>
              <option value="food">饮食</option>
              <option value="energy">能源</option>
              <option value="shopping">购物</option>
            </select>
          </div>
          <div>
            <label for="activity">具体活动</label>
            <input type="text" id="activity" required placeholder="例如: 开车上班">
          </div>
          <div>
            <label for="amount">数量</label>
            <input type="number" id="amount" step="0.1" required placeholder="例如: 50 (公里/千克)">
          </div>
          <div>
            <label for="unit">单位</label>
            <select id="unit" required>
              <option value="km">公里</option>
              <option value="kg">千克</option>
              <option value="kwh">千瓦时</option>
              <option value="item">件</option>
            </select>
          </div>
          <div>
            <label for="co2">二氧化碳排放量(kg)</label>
            <input type="number" id="co2" step="0.01" required placeholder="自动计算或手动输入">
          </div>
          <button type="submit">保存记录</button>
        </form>
      </div>

      <div class="list-section">
        <h2>您的碳足迹记录</h2>
        <table id="recordsTable">
          <thead>
            <tr>
              <th>日期</th>
              <th>类别</th>
              <th>活动</th>
              <th>数量</th>
              <th>CO₂(kg)</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="chart-container">
      <h2>碳足迹可视化分析</h2>
      <div class="chart-row">
        <div class="chart-item">
          <canvas id="categoryChart"></canvas>
        </div>
        <div class="chart-item">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <div class="chart-row">
        <div class="chart-item">
          <canvas id="comparisonChart"></canvas>
        </div>
        <div class="chart-item">
          <div id="comparisonText" style="padding: 20px; background: #f8f8f8; border-radius: 8px;">
            <h3>月度碳排放对比分析</h3>
            <div class="month-selector">
              <label for="compareMonth1">比较月份:</label>
              <select id="compareMonth1"></select>
              <label for="compareMonth2">与:</label>
              <select id="compareMonth2"></select>
            </div>
            <p id="comparisonResult">请选择要比较的两个月份</p>
            <p id="comparisonTips"></p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 图表实例变量
      let categoryChartInstance = null;
      let monthlyChartInstance = null;
      let comparisonChartInstance = null;

      // 碳足迹数据管理对象
      const CarbonFootprintManager = {
        init: function () {
          if (!localStorage.getItem('carbonFootprints')) {
            const initialData = {
              records: [],
              emissionFactors: {
                transport: {
                  "开车(汽油车)": 0.25, // kg CO2/km
                  "公交车": 0.1,
                  "地铁": 0.05,
                  "飞机": 0.18,
                  "火车": 0.06
                },
                food: {
                  "牛肉": 27.0, // kg CO2/kg
                  "鸡肉": 6.9,
                  "猪肉": 12.1,
                  "蔬菜": 2.0,
                  "大米": 4.0
                },
                energy: {
                  "电力": 0.85, // kg CO2/kWh (取决于能源结构)
                  "天然气": 2.0, // kg CO2/m³
                  "自来水": 0.0003 // kg CO2/L
                },
                shopping: {
                  "衣服": 15.0, // kg CO2/item
                  "电子产品": 50.0,
                  "塑料制品": 3.0
                }
              }
            };
            this.saveData(initialData);
          }
        },
        // 新增目标设置功能

        // 初始化数据

        // 保存数据到localStorage
        saveData: function (data) {
          localStorage.setItem('carbonFootprints', JSON.stringify(data));
        },

        // 从localStorage加载数据
        loadData: function () {
          return JSON.parse(localStorage.getItem('carbonFootprints'));
        },

        // 添加新记录
        addRecord: function (record) {
          const data = this.loadData();
          record.id = Date.now().toString();
          data.records.push(record);
          this.saveData(data);
          this.updateGoalProgress(); // 添加记录后更新进度
          return data;
        },

        // 其他方法保持不变，添加目标相关方法
        setMonthlyGoal: function (goal) {
          const data = this.loadData();
          data.monthlyGoal = Number(goal);
          this.saveData(data);
          this.updateGoalProgress(); // 设置目标后立即更新进度
        },
        updateGoalProgress: function () {
          const data = this.loadData();
          const currentTotal = this.getCurrentMonthTotal();
          const goal = data.monthlyGoal || 0;

          const progressBar = document.getElementById('goalProgress');
          const statusText = document.getElementById('goalStatus');

          if (!goal) {
            progressBar.style.width = '0%';
            statusText.textContent = '请先设置月度目标';
            return;
          }

          const percentage = (currentTotal / goal) * 100;
          progressBar.style.width = `${Math.min(percentage, 100)}%`;

          if (percentage > 100) {
            statusText.innerHTML = `⚠️ 已超出目标 ${(currentTotal - goal).toFixed(1)}kg`;
            progressBar.style.background = '#c62828';
          } else {
            statusText.innerHTML = `✅ 剩余额度 ${(goal - currentTotal).toFixed(1)}kg`;
            progressBar.style.background = '#2e7d32';
          }
        },
        getCurrentMonthTotal() {
          const data = this.loadData();
          const currentMonth = new Date().toISOString().slice(0, 7);
          return data.records
            .filter(r => r.date.startsWith(currentMonth))
            .reduce((sum, r) => sum + Number(r.co2), 0);
        },

        updateGoalProgress() {
          const data = this.loadData();
          const currentTotal = this.getCurrentMonthTotal();
          const goal = data.monthlyGoal;

          const progressBar = document.getElementById('goalProgress');
          const statusText = document.getElementById('goalStatus');

          if (!goal) {
            progressBar.style.width = '0%';
            statusText.textContent = '请先设置月度目标';
            return;
          }

          const percentage = (currentTotal / goal) * 100;
          progressBar.style.width = `${Math.min(percentage, 100)}%`;

          if (percentage > 100) {
            statusText.innerHTML = `⚠️ 已超出目标 ${(currentTotal - goal).toFixed(1)}kg`;
            progressBar.style.background = '#c62828';
          } else {
            statusText.innerHTML = `✅ 剩余额度 ${(goal - currentTotal).toFixed(1)}kg`;
            progressBar.style.background = '#2e7d32';
          }
        },

        // 导出CSV方法
        exportToCSV() {
          const data = this.loadData();
          const csvContent = [
            ['日期', '类别', '活动', '数量', '单位', 'CO2排放(kg)'].join(','),
            ...data.records.map(r => [
              r.date,
              this.getCategoryName(r.category),
              r.activity,
              r.amount,
              r.unit,
              r.co2
            ].join(','))
          ].join('\n');

          const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `碳足迹数据_${new Date().toISOString().slice(0, 10)}.csv`;
          link.click();
        },

        // 生成建议方法
        generateTips() {
          const categoryData = this.getCategoryData();
          if (categoryData.values.length === 0) return '暂无建议';

          const maxValue = Math.max(...categoryData.values);
          const maxCategory = categoryData.labels[categoryData.values.indexOf(maxValue)];

          const tips = {
            transport: '建议多使用公共交通，合理规划出行路线',
            food: '尝试增加植物性饮食，减少食物浪费',
            energy: '使用节能电器，适当调整空调温度',
            shopping: '选择环保商品，减少不必要的购物'
          };

          return tips[maxCategory] || '继续保持良好的环保习惯！';
        },

        // 更新记录
        updateRecord: function (id, updatedRecord) {
          const data = this.loadData();
          const index = data.records.findIndex(r => r.id === id);
          if (index !== -1) {
            data.records[index] = { ...data.records[index], ...updatedRecord };
            this.saveData(data);
            this.updateGoalProgress(); // 更新记录后更新进度
          }
          return data;
        },

        // 删除记录
        deleteRecord: function (id) {
          const data = this.loadData();
          data.records = data.records.filter(r => r.id !== id);
          this.saveData(data);
          this.updateGoalProgress(); // 删除记录后更新进度
          return data;
        },

        // 计算碳排放量
        calculateCO2: function (category, activity, amount) {
          const data = this.loadData();
          const factor = data.emissionFactors[category]?.[activity];
          return factor ? (factor * amount).toFixed(2) : null;
        },

        // 获取所有有数据的月份(按时间排序)
        getAllMonthsWithData: function () {
          const data = this.loadData();
          const monthsMap = {};

          // 收集所有有数据的月份
          data.records.forEach(record => {
            const recordDate = new Date(record.date);
            const monthLabel = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}`;
            monthsMap[monthLabel] = true;
          });

          // 转换为数组并排序
          const months = Object.keys(monthsMap);
          months.sort((a, b) => {
            const dateA = new Date(a);
            const dateB = new Date(b);
            return dateA - dateB;
          });

          return months;
        },

        // 获取各月碳排放数据
        getMonthlyData: function () {
          const data = this.loadData();
          const months = this.getAllMonthsWithData();
          const monthlyData = {};

          // 初始化每月数据
          months.forEach(month => {
            monthlyData[month] = 0;
          });

          // 计算每月碳排放总量
          data.records.forEach(record => {
            const recordDate = new Date(record.date);
            const monthLabel = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}`;

            if (monthlyData.hasOwnProperty(monthLabel)) {
              monthlyData[monthLabel] += parseFloat(record.co2);
            }
          });

          return {
            labels: months,
            values: months.map(month => monthlyData[month])
          };
        },

        // 按类别统计碳排放
        getCategoryData: function () {
          const data = this.loadData();
          const categories = {};

          data.records.forEach(record => {
            if (!categories[record.category]) {
              categories[record.category] = 0;
            }
            categories[record.category] += parseFloat(record.co2);
          });

          return {
            labels: Object.keys(categories),
            values: Object.values(categories)
          };
        },

        // 获取指定月份的碳排放量
        getMonthData: function (monthLabel) {
          const data = this.loadData();
          let total = 0;

          data.records.forEach(record => {
            const recordDate = new Date(record.date);
            const recordMonth = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}`;

            if (recordMonth === monthLabel) {
              total += parseFloat(record.co2);
            }
          });

          return total;
        },

        // 比较两个月份的碳排放数据
        compareMonths: function (month1, month2) {
          const month1Total = this.getMonthData(month1);
          const month2Total = this.getMonthData(month2);

          const difference = month1Total - month2Total;
          let percentage = 0;

          if (month2Total > 0) {
            percentage = (difference / month2Total) * 100;
          } else if (month1Total > 0) {
            percentage = 100; // 上月为0，本月有数据，视为增加100%
          }

          return {
            month1: month1Total,
            month2: month2Total,
            difference: difference,
            percentage: percentage,
            month1Label: month1,
            month2Label: month2
          };
        }

      };

      document.addEventListener('DOMContentLoaded', () => {
        CarbonFootprintManager.init();
        setupEventListeners();
        renderAll();
        CarbonFootprintManager.updateGoalProgress(); // 初始化时显示目标进度

        // 添加移动端菜单交互
        document.querySelector('.navicon').addEventListener('click', function (e) {
          e.preventDefault();
          this.classList.toggle('navicon--active');
          document.querySelector('.toggle').classList.toggle('toggle--active');
        });
      });

      function renderAll() {
        renderRecords();
        renderCharts();
        updateMonthSelectors();
        renderTips();
      }

      function renderTips() {
        const tip = CarbonFootprintManager.generateTips();
        const tipCard = document.createElement('div');
        tipCard.className = 'tip-card';
        tipCard.innerHTML = `
                    <h3>减排小贴士</h3>
                    <p>${tip}</p>
                `;
        document.querySelector('.form-section').appendChild(tipCard);
      }
      // 初始化应用
      document.addEventListener('DOMContentLoaded', function () {
        CarbonFootprintManager.init();
        renderRecords();
        setupEventListeners();
        renderCharts(); // 初始化时渲染图表
        updateMonthSelectors(); // 初始化月份选择器
      });

      // 渲染记录表格
      function renderRecords() {
        const data = CarbonFootprintManager.loadData();
        const tbody = document.querySelector('#recordsTable tbody');
        tbody.innerHTML = '';

        // 按日期降序排序
        const sortedRecords = [...data.records].sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedRecords.forEach(record => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
                        <td>${record.date}</td>
                        <td>${getCategoryName(record.category)}</td>
                        <td>${record.activity}</td>
                        <td>${record.amount} ${record.unit}</td>
                        <td>${record.co2}</td>
                        <td class="action-buttons">
                            <button onclick="editRecord('${record.id}')">编辑</button>
                            <button onclick="deleteRecord('${record.id}')">删除</button>
                        </td>
                    `;
          tbody.appendChild(tr);
        });
      }

      function setMonthlyGoal() {
        const goalInput = document.getElementById('monthlyGoal');
        const goalValue = goalInput.value;

        if (!goalValue || isNaN(goalValue)) {
          alert('请输入有效的数值');
          return;
        }

        CarbonFootprintManager.setMonthlyGoal(goalValue);
        goalInput.value = '';

        // 更新图表和记录显示
        renderRecords();
        updateCharts();
      }

      // 修改导出函数
      function exportData() {
        CarbonFootprintManager.exportToCSV();
      }
      // 获取类别中文名称
      function getCategoryName(category) {
        const names = {
          transport: '交通',
          food: '饮食',
          energy: '能源',
          shopping: '购物'
        };
        return names[category] || category;
      }

      // 设置事件监听器
      function setupEventListeners() {
        // 表单提交
        document.getElementById('carbonForm').addEventListener('submit', function (e) {
          e.preventDefault();

          const category = document.getElementById('category').value;
          const activity = document.getElementById('activity').value;
          const amount = parseFloat(document.getElementById('amount').value);

          // 自动计算CO2排放量
          let co2 = parseFloat(document.getElementById('co2').value);
          if (!co2 || isNaN(co2)) {
            co2 = CarbonFootprintManager.calculateCO2(category, activity, amount);
            if (!co2) {
              alert('添加成功！');
              return;
            }
            document.getElementById('co2').value = co2;
          }

          const newRecord = {
            date: document.getElementById('date').value,
            category: category,
            activity: activity,
            amount: amount,
            unit: document.getElementById('unit').value,
            co2: co2
          };

          CarbonFootprintManager.addRecord(newRecord);
          renderRecords();
          updateCharts(); // 添加记录后更新图表
          updateMonthSelectors(); // 更新月份选择器
          this.reset();
          document.getElementById('date').valueAsDate = new Date(); // 重置为今天
        });

        // 日期默认设为今天
        document.getElementById('date').valueAsDate = new Date();

        // 类别变化时更新活动建议
        document.getElementById('category').addEventListener('change', function () {
          const data = CarbonFootprintManager.loadData();
          const category = this.value;
          const activities = data.emissionFactors[category] ? Object.keys(data.emissionFactors[category]) : [];
        });

        // 月份选择器变化时更新对比
        document.getElementById('compareMonth1').addEventListener('change', updateComparison);
        document.getElementById('compareMonth2').addEventListener('change', updateComparison);
      }

      // 更新月份选择器
      function updateMonthSelectors() {
        const months = CarbonFootprintManager.getAllMonthsWithData();
        const month1Select = document.getElementById('compareMonth1');
        const month2Select = document.getElementById('compareMonth2');

        // 清空现有选项
        month1Select.innerHTML = '';
        month2Select.innerHTML = '';

        // 添加月份选项
        months.forEach(month => {
          const option1 = document.createElement('option');
          option1.value = month;
          option1.textContent = month;

          const option2 = document.createElement('option');
          option2.value = month;
          option2.textContent = month;

          month1Select.appendChild(option1);
          month2Select.appendChild(option2);
        });

        // 默认选择最近两个月(如果有)
        if (months.length >= 2) {
          month1Select.value = months[months.length - 1];
          month2Select.value = months[months.length - 2];
        } else if (months.length === 1) {
          month1Select.value = months[0];
        }

        // 如果有变化则更新对比
        if (months.length >= 2) {
          updateComparison();
        }
      }

      // 编辑记录
      function editRecord(id) {
        const data = CarbonFootprintManager.loadData();
        const record = data.records.find(r => r.id === id);

        if (record) {
          document.getElementById('date').value = record.date;
          document.getElementById('category').value = record.category;
          document.getElementById('activity').value = record.activity;
          document.getElementById('amount').value = record.amount;
          document.getElementById('unit').value = record.unit;
          document.getElementById('co2').value = record.co2;

          // 临时修改表单提交行为为更新
          const form = document.getElementById('carbonForm');
          const originalSubmitHandler = form.onsubmit;

          form.onsubmit = function (e) {
            e.preventDefault();

            const updatedRecord = {
              date: document.getElementById('date').value,
              category: document.getElementById('category').value,
              activity: document.getElementById('activity').value,
              amount: parseFloat(document.getElementById('amount').value),
              unit: document.getElementById('unit').value,
              co2: parseFloat(document.getElementById('co2').value)
            };

            CarbonFootprintManager.updateRecord(id, updatedRecord);
            renderRecords();
            updateCharts(); // 更新记录后更新图表
            updateMonthSelectors(); // 更新月份选择器

            // 恢复表单原始提交行为
            form.reset();
            form.onsubmit = originalSubmitHandler;
            document.getElementById('date').valueAsDate = new Date();
          };
        }
      }

      // 删除记录
      function deleteRecord(id) {
        if (confirm('确定要删除这条记录吗？')) {
          CarbonFootprintManager.deleteRecord(id);
          renderRecords();
          updateCharts(); // 删除记录后更新图表
          updateMonthSelectors(); // 更新月份选择器
        }
      }

      // 渲染图表
      function renderCharts() {
        // 类别分布饼图
        const categoryData = CarbonFootprintManager.getCategoryData();
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');

        // 销毁旧图表实例
        if (categoryChartInstance) {
          categoryChartInstance.destroy();
        }

        categoryChartInstance = new Chart(categoryCtx, {
          type: 'pie',
          data: {
            labels: categoryData.labels.map(getCategoryName),
            datasets: [{
              data: categoryData.values,
              backgroundColor: [
                '#4CAF50',
                '#2196F3',
                '#FFC107',
                '#FF5722'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '碳排放类别分布'
              }
            }
          }
        });

        // 月度趋势图
        const monthlyData = CarbonFootprintManager.getMonthlyData();
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');

        // 销毁旧图表实例
        if (monthlyChartInstance) {
          monthlyChartInstance.destroy();
        }

        monthlyChartInstance = new Chart(monthlyCtx, {
          type: 'bar',
          data: {
            labels: monthlyData.labels,
            datasets: [{
              label: '碳排放量 (kg)',
              data: monthlyData.values,
              backgroundColor: '#2E7D32'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '历史月度碳排放趋势'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // 更新对比分析
      function updateComparison() {
        const month1 = document.getElementById('compareMonth1').value;
        const month2 = document.getElementById('compareMonth2').value;

        if (!month1 || !month2) {
          document.getElementById('comparisonResult').textContent = "请选择要比较的两个月份";
          document.getElementById('comparisonTips').textContent = "";
          return;
        }

        const comparisonData = CarbonFootprintManager.compareMonths(month1, month2);
        const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');

        // 销毁旧图表实例

        // 确定颜色 (增加为红色，减少为绿色)

        // 销毁旧图表实例
        if (comparisonChartInstance) {
          comparisonChartInstance.destroy();
        }

        // 确定颜色 (增加为红色，减少为绿色)
        const colors = [
          comparisonData.difference >= 0 ? '#f44336' : '#4CAF50',
          '#9E9E9E'
        ];

        comparisonChartInstance = new Chart(comparisonCtx, {
          type: 'bar',
          data: {
            labels: [comparisonData.month1Label, comparisonData.month2Label],
            datasets: [{
              label: '碳排放量 (kg)',
              data: [comparisonData.month1, comparisonData.month2],
              backgroundColor: colors
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '月度碳排放对比'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });

        // 更新文本分析
        updateComparisonText(comparisonData);
      }

      // 更新对比分析文本
      function updateComparisonText(data) {
        const comparisonResult = document.getElementById('comparisonResult');
        const comparisonTips = document.getElementById('comparisonTips');

        if (data.difference > 0) {
          // 碳排放增加
          comparisonResult.innerHTML = `
            ${data.month1Label}碳排放量为 <strong>${data.month1.toFixed(2)}kg</strong>，
            比${data.month2Label}的 <strong>${data.month2.toFixed(2)}kg</strong>
            <span class="comparison-positive">增加了 ${Math.abs(data.difference).toFixed(2)}kg (${Math.abs(data.percentage).toFixed(1)}%)</span>
        `;
          comparisonTips.textContent = "碳排放量有所增加，建议检查交通和能源使用情况，寻找减排机会。";
        } else if (data.difference < 0) {
          // 碳排放减少
          comparisonResult.innerHTML = `
            ${data.month1Label}碳排放量为 <strong>${data.month1.toFixed(2)}kg</strong>，
            比${data.month2Label}的 <strong>${data.month2.toFixed(2)}kg</strong>
            <span class="comparison-negative">减少了 ${Math.abs(data.difference).toFixed(2)}kg (${Math.abs(data.percentage).toFixed(1)}%)</span>
        `;
          comparisonTips.textContent = "恭喜！碳排放量有所减少，继续保持良好的环保习惯。";
        } else {
          // 无变化或数据不足
          if (data.month1 === 0 && data.month2 === 0) {
            comparisonResult.innerHTML = "选择的月份没有足够数据进行比较分析";
            comparisonTips.textContent = "";
          } else {
            comparisonResult.innerHTML = `
                ${data.month1Label}碳排放量为 <strong>${data.month1.toFixed(2)}kg</strong>，
                与${data.month2Label}的 <strong>${data.month2.toFixed(2)}kg</strong> 基本持平
            `;
            comparisonTips.textContent = "碳排放量保持稳定，可以考虑设定减排目标以进一步降低碳足迹。";
          }
        }
      }

      // 更新图表数据
      function updateCharts() {
        // 类别分布饼图
        const categoryData = CarbonFootprintManager.getCategoryData();

        categoryChartInstance.data.labels = categoryData.labels.map(getCategoryName);
        categoryChartInstance.data.datasets[0].data = categoryData.values;
        categoryChartInstance.update();

        // 月度趋势图
        const monthlyData = CarbonFootprintManager.getMonthlyData();

        monthlyChartInstance.data.labels = monthlyData.labels;
        monthlyChartInstance.data.datasets[0].data = monthlyData.values;
        monthlyChartInstance.update();
      }
    </script>

    <div class="clearfix"> </div>
    <!-- //footer -->
    <!-- menu-js -->

    <!-- //menu-js -->
    <!-- smooth-scrolling-of-move-up -->
    <script type="text/javascript">
      $(document).ready(function () {
        /*
        var defaults = {
            containerID: 'toTop', // fading element id
            containerHoverID: 'toTopHover', // fading element hover id
            scrollSpeed: 1200,
            easingType: 'linear' 
        };
        */

        $().UItoTop({ easingType: 'easeOutQuart' });

      });
    </script>
    <!-- //smooth-scrolling-of-move-up -->
    <!-- Bootstrap core JavaScript
================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/bootstrap.js"></script>
</body>

</html>